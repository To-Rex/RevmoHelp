import{l as s,s as a,a8 as l}from"./index-DO34fR0A.js";const u=async()=>{try{if(console.log("ðŸ”” Loading user notifications..."),!s()||!a)return console.log("âš ï¸ Supabase not available, using mock data"),{data:d(),error:null};const{data:{user:t}}=await a.auth.getUser();if(!t)return{data:[],error:null};const e=await a.from("notifications").select(`
        *,
        post:posts(id, title, slug),
        creator:profiles!notifications_created_by_fkey(id, full_name, role)
      `).eq("active",!0).or("expires_at.is.null,expires_at.gt.now()").eq("target_type","broadcast").order("sent_at",{ascending:!1}),r=await a.from("notifications").select(`
        *,
        post:posts(id, title, slug),
        creator:profiles!notifications_created_by_fkey(id, full_name, role)
      `).eq("active",!0).or("expires_at.is.null,expires_at.gt.now()").eq("target_type","individual").eq("target_user_id",t.id).order("sent_at",{ascending:!1});if(e.error||r.error)return console.log("âŒ Supabase error loading notifications:",e.error||r.error),{data:d(),error:null};const i=[...e.data||[],...r.data||[]];return i.sort((n,o)=>new Date(o.sent_at||0).getTime()-new Date(n.sent_at||0).getTime()),console.log("âœ… Notifications loaded from Supabase:",i.length),{data:i,error:null}}catch(t){return console.warn("ðŸ”” Error fetching notifications, using mock data:",t),{data:d(),error:null}}},f=async()=>{try{if(!s()||!a)return{data:d(),error:null};const{data:t,error:e}=await a.from("notifications").select(`
        *,
        post:posts(id, title, slug),
        creator:profiles!notifications_created_by_fkey(id, full_name, role)
      `).order("created_at",{ascending:!1});return{data:t,error:e}}catch(t){return{data:null,error:t}}},g=async t=>{try{if(!s()||!a)return{data:{id:Date.now().toString(),...t,created_by:"demo-admin",read_by:[],sent_at:new Date().toISOString(),active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},error:null};const e=l();let r;if(!e){const{data:{user:o}}=await a.auth.getUser();if(!o)return{data:null,error:{message:"User not authenticated"}};r=o.id}const{data:i,error:n}=await a.from("notifications").insert({...t,...r&&{created_by:r},active:!0,sent_at:new Date().toISOString()}).select(`
        *,
        post:posts(id, title, slug),
        creator:profiles!notifications_created_by_fkey(id, full_name, role)
      `).single();return n?(console.log("âš ï¸ Supabase insert failed, using mock:",n),{data:{id:Date.now().toString(),...t,created_by:e?void 0:"system",read_by:[],sent_at:new Date().toISOString(),active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()},error:null}):{data:i,error:n}}catch(e){return{data:null,error:e}}},_=async t=>{try{if(!s()||!a)return{error:null};const{data:{user:e}}=await a.auth.getUser();if(!e)return{error:{message:"User not authenticated"}};const{data:r}=await a.from("notifications").select("read_by").eq("id",t).single();if(!r)return{error:{message:"Notification not found"}};const i=r.read_by||[];if(!i.includes(e.id)){i.push(e.id);const{error:n}=await a.from("notifications").update({read_by:i}).eq("id",t);return{error:n}}return{error:null}}catch(e){return{error:e}}},m=async t=>{try{if(!s()||!a)return{error:null};const{error:e}=await a.from("notifications").delete().eq("id",t);return{error:e}}catch(e){return{error:e}}},y=async()=>{try{if(!s()||!a)return{count:2,error:null};const{data:{user:t}}=await a.auth.getUser();if(!t)return{count:0,error:null};const{data:e,error:r}=await a.from("notifications").select("id, read_by").eq("active",!0).or("expires_at.is.null,expires_at.gt.now()").or(`target_type.eq.broadcast,and(target_type.eq.individual,target_user_id.eq.${t.id})`);return r?{count:0,error:r}:{count:e?.filter(n=>!(n.read_by||[]).includes(t.id)).length||0,error:null}}catch(t){return{count:0,error:t}}},d=()=>[{id:"1",title:"Yangi maqola nashr etildi",message:'Dr. Aziza Karimova tomonidan "Revmatoid artrit: zamonaviy davolash usullari" maqolasi nashr etildi.',type:"info",target_type:"broadcast",post_id:"1",created_by:"admin-1",read_by:[],sent_at:new Date().toISOString(),active:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString(),post:{id:"1",title:"Revmatoid artrit: zamonaviy davolash usullari",slug:"revmatoid-artrit-zamonaviy-davolash"},creator:{id:"admin-1",full_name:"Admin User",role:"admin"}},{id:"2",title:"Profilingiz yangilandi",message:"Sizning profil ma'lumotlaringiz muvaffaqiyatli yangilandi.",type:"success",target_type:"individual",created_by:"system",read_by:[],sent_at:new Date(Date.now()-864e5).toISOString(),active:!0,created_at:new Date(Date.now()-864e5).toISOString(),updated_at:new Date(Date.now()-864e5).toISOString(),creator:{id:"system",full_name:"System",role:"admin"}},{id:"3",title:"Yangi shifokor qo'shildi",message:"Dr. Bobur Toshmatov platformaga qo'shildi va endi konsultatsiya beradi.",type:"info",target_type:"broadcast",created_by:"admin-1",read_by:["user-1"],sent_at:new Date(Date.now()-1728e5).toISOString(),active:!0,created_at:new Date(Date.now()-1728e5).toISOString(),updated_at:new Date(Date.now()-1728e5).toISOString(),creator:{id:"admin-1",full_name:"Admin User",role:"admin"}}];export{u as a,y as b,g as c,m as d,f as g,_ as m};
